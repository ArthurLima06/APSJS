<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Calculadora de Carbono ‚Äî Visual</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; display:flex; justify-content:center; }
    .card { width:760px; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); margin:40px; padding:24px; }
    h1 { margin:0 0 8px 0; }
    .row { display:flex; gap:12px; margin-top:12px; }
    .col { flex:1; }
    input, select { width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; font-size:14px; box-sizing:border-box; }
    button { padding:10px 16px; border-radius:6px; border:none; background:#2d89ef; color:#fff; cursor:pointer; font-weight:600; }
    button:hover { background:#1c65b8; }
    #resultadoBox { margin-top:16px; padding:12px; border-radius:6px; background:#f7f9fb; }
    .badge { display:inline-block; padding:6px 10px; border-radius:6px; font-weight:700; color:#fff; }
    .abaixo { background:#28a745; } .media { background:#f0ad4e; } .acima { background:#d9534f; }
    #chartWrapper { margin-top:18px; background:#fff; padding:12px; border-radius:8px; }
    .small { font-size:13px; color:#666; margin-top:6px; }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="card">
    <h1>üå± Calculadora de Carbono (Visual)</h1>
    <p class="small">Preencha dist√¢ncia, consumo (litros) e escolha o ve√≠culo. Para avi√£o, informe passageiros.</p>

    <div class="row">
      <div class="col">
        <label>Dist√¢ncia (km)</label>
        <input id="km" type="number" placeholder="Ex.: 100" />
      </div>
      <div class="col">
        <label>Consumo (litros)</label>
        <input id="combustivel" type="number" placeholder="Litros consumidos" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Tipo de ve√≠culo</label>
        <select id="tipo" onchange="onTipoChange()">
          <option value="todos">Todos (m√©dia)</option>
          <option value="carro">Carro</option>
          <option value="moto">Moto</option>
          <option value="avi√£o">Avi√£o</option>
          <option value="barco">Barco</option>
        </select>
      </div>
      <div class="col" id="passageirosCol" style="display:none;">
        <label>N¬∫ de passageiros (avi√£o)</label>
        <input id="passageiros" type="number" placeholder="Ex.: 1" min="1" />
      </div>
      <div style="display:flex; align-items:flex-end;">
        <button onclick="calcular()">Calcular</button>
      </div>
    </div>

    <div id="resultadoBox" style="display:none;">
      <div id="resultadoTexto"></div>
      <div id="classificacaoBadge" style="margin-top:8px;"></div>
      <div id="detalhesTodos" style="margin-top:8px;"></div>
    </div>

    <div id="chartWrapper" style="display:none;">
      <canvas id="chart" width="720" height="320"></canvas>
    </div>
  </div>

<script>
const API = "http://127.0.0.1:8000/calcular";
let chartInstance = null;

function onTipoChange(){
  const tipo = document.getElementById("tipo").value;
  document.getElementById("passageirosCol").style.display = (tipo === "avi√£o") ? "block" : "none";
}

function montarBadge(classificacao){
  if(classificacao === "abaixo") return `<span class="badge abaixo">ABAIXO DA M√âDIA</span>`;
  if(classificacao === "na m√©dia") return `<span class="badge media">NA M√âDIA</span>`;
  return `<span class="badge acima">ACIMA DA M√âDIA</span>`;
}

function limparChart(){
  if(chartInstance){
    chartInstance.destroy();
    chartInstance = null;
  }
  document.getElementById("chartWrapper").style.display = "none";
}

async function calcular(){
  limparChart();
  const km = parseFloat(document.getElementById("km").value);
  const combustivel = parseFloat(document.getElementById("combustivel").value);
  const tipo = document.getElementById("tipo").value;
  const passageiros = parseInt(document.getElementById("passageiros").value);

  if(isNaN(km) || isNaN(combustivel) || km <= 0 || combustivel < 0){
    alert("Preencha dist√¢ncia e combust√≠vel corretamente.");
    return;
  }

  const payload = { km, combustivel, tipo };
  if(tipo === "avi√£o" && !isNaN(passageiros) && passageiros > 0) payload.passageiros = passageiros;

  try {
    const resp = await fetch(API, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if(!resp.ok){
      alert("Erro na API: " + resp.status);
      return;
    }

    const json = await resp.json();
    document.getElementById("resultadoBox").style.display = "block";

    // caso 'todos' -> lista de detalhes
    if(json.tipo === "todos"){
      const detalhes = json.detalhes;
      // montando texto e badge por m√©dia geral
      document.getElementById("resultadoTexto").innerHTML = `<strong>M√©dia geral:</strong> ${json.media_geral.toFixed(3)} kg CO‚ÇÇ (m√©dia entre ve√≠culos)`;
      // criar lista com o detalhamento
      let html = "<table style='width:100%; margin-top:8px; border-collapse:collapse;'><tr><th style='text-align:left'>Ve√≠culo</th><th>Voc√™ (kg)</th><th>M√©dia (kg)</th><th>Status</th></tr>";
      const labels = [];
      const valoresUsuario = [];
      const valoresMedia = [];
      detalhes.forEach(d => {
        html += `<tr>
          <td style="padding:6px 0">${d.tipo}</td>
          <td style="text-align:center">${d.emissao_usuario.toFixed(3)}</td>
          <td style="text-align:center">${d.media_esperada.toFixed(3)}</td>
          <td style="text-align:center">${montarBadge(d.classificacao)}</td>
        </tr>`;
        labels.push(d.tipo);
        valoresUsuario.push(d.emissao_usuario);
        valoresMedia.push(d.media_esperada);
      });
      html += "</table>";
      document.getElementById("detalhesTodos").innerHTML = html;
      // badge geral n√£o aplic√°vel (cada ve√≠culo tem)
      document.getElementById("classificacaoBadge").innerHTML = "";

      // gr√°fico comparativo (todos os ve√≠culos)
      showChart(labels, valoresUsuario, valoresMedia);

    } else {
      // √∫nico ve√≠culo
      document.getElementById("detalhesTodos").innerHTML = "";
      document.getElementById("resultadoTexto").innerHTML =
        `<strong>${json.tipo.toUpperCase()}</strong> ‚Äî Sua emiss√£o: ${json.emissao_usuario.toFixed(3)} kg CO‚ÇÇ<br><small> M√©dia esperada: ${json.media_esperada.toFixed(3)} kg CO‚ÇÇ</small>`;
      document.getElementById("classificacaoBadge").innerHTML = montarBadge(json.classificacao);

      // gr√°fico: 2 barras (voc√™ x m√©dia)
      showChart([json.tipo], [json.emissao_usuario], [json.media_esperada]);
    }

  } catch (err) {
    console.error(err);
    alert("Erro ao conectar com o servidor (verifique se o backend est√° rodando).");
  }
}

function showChart(labels, valoresUsuario, valoresMedia){
  document.getElementById("chartWrapper").style.display = "block";
  const ctx = document.getElementById("chart").getContext("2d");

  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Voc√™ (kg CO‚ÇÇ)",
          data: valoresUsuario,
          backgroundColor: "rgba(45,137,239,0.8)"
        },
        {
          label: "M√©dia esperada (kg CO‚ÇÇ)",
          data: valoresMedia,
          backgroundColor: "rgba(200,200,200,0.8)"
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: {
        legend: { position: "top" }
      }
    }
  });
}
</script>
</body>
</html>
